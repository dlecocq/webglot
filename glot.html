<!DOCTYPE html>
<html>
<head>
	<title>OpenGLot Alpha</title>
	<script src="stopwatch.js"> </script>
	<script src="curve.js"> </script>
	<script src="scalar_field.js"> </script>
	<script src="CanvasMatrix.js"> </script>
	<script src="screen.js"> </script>
	<script src="grapher.js"> </script>
	
	<script type="x-shader/x-vertex" id="vshader">
	uniform mat4 u_modelViewMatrix;
	uniform mat4 u_projectionMatrix;
	
  attribute vec4 vPosition;

	uniform float t;
	
	void main() {
		float x = vPosition.x;
		gl_Position = u_projectionMatrix * vec4(x, sin(x * t), 0, 1);
	}
	</script>
	
	<script type="x-shader/x-vertex" id="vshader2">
	uniform mat4 u_modelViewMatrix;
	uniform mat4 u_projectionMatrix;
	
	attribute vec4 vTexCoord;
  attribute vec4 vPosition;

	varying vec2 v_texCoord;
	
	void main() {
		gl_Position = u_projectionMatrix * vPosition;
		v_texCoord = vTexCoord.st;
	}
	</script>
	
	<script type="x-shader/x-fragment" id="fshader">
	void main() {
		gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
	}
	</script>
	
	<script src="scalar.frag.js" type="x-shader/x-fragment" id="fshader2">
	varying vec2 v_texCoord;
	uniform float t;
	
	void main () {

		float x = v_texCoord.x;
		float y = v_texCoord.y;
		
		float value = sin(3.0 * sqrt(x * x + y * y) - 2.0 * t) * cos(5.0 * sqrt((x - 1.5) * (x - 1.5) + (y - 0.75) * (y - 0.75)) - t);
			value = (value + 1.0) / 2.0;

			value = 1.0 - value;
			float red = 1.0;
			float green = 1.0;
			float blue = 0.0;

			if (value > 0.8) {
				red = (value - 0.8) * 5.0;
				green = 0.0;
				blue = 1.0;
			} else if (value > 0.6) {
				red = 0.0;
				green = (0.8 - value) * 5.0;
				blue = 1.0;
			} else if (value > 0.4) {
				red = (0.6 - value) * 5.0;
				green = 1.0;
				blue = (value - 0.4) * 5.0;
			} else if (value > 0.2) {
				red = 1.0;
				green = 0.5 + (value - 0.2) * 2.5;
			} else {
				red = 1.0;
				green = (value) * 2.5;
			}

			gl_FragColor = vec4(red, green, blue, 0.5);
		}
	</script>

	<script>
	function loadShader(ctx, shaderId) {
		var shaderScript = document.getElementById(shaderId);
		if (!shaderScript) {
		    return null;
		}

		if (shaderScript.type == "x-shader/x-vertex") {
			//alert("Vertex shader");
			var shaderType = ctx.VERTEX_SHADER;
		} else if (shaderScript.type == "x-shader/x-fragment") {
			//alert("Fragment shader");
	    var shaderType = ctx.FRAGMENT_SHADER;
		} else {
		    return null;
		}

		// Create the shader object
		var shader = ctx.createShader(shaderType);
		if (shader == null) {
		    return null;
		}

		// Load the shader source
		ctx.shaderSource(shader, shaderScript.text);

		// Compile the shader
		ctx.compileShader(shader);

		// Check the compile status
		var compiled = ctx.getShaderParameter(shader, ctx.COMPILE_STATUS);
		if (!compiled) {
		    // Something went wrong during compilation; get the error
		    var error = ctx.getShaderInfoLog(shader);
				alert(error);
		    ctx.deleteShader(shader);
		    return null;
		}

		return shader;
	}
	
	function gen_shaders(gl) {
		var vertexShader = loadShader(gl, "vshader");
    var fragmentShader = loadShader(gl, "fshader");

    if (!vertexShader || !fragmentShader)
        return null;

    // Create the program object
    gl.program = gl.createProgram();

    if (!gl.program)
        return null;

    // Attach our two shaders to the program
    gl.attachShader (gl.program, vertexShader);
    gl.attachShader (gl.program, fragmentShader);

    // Link the program
    gl.linkProgram(gl.program);

    // Check the link status
    var linked = gl.getProgramParameter(gl.program, gl.LINK_STATUS);
    if (!linked) {
        // something went wrong with the link
        var error = gl.getProgramInfoLog (gl.program);
        gl.console.log("Error in program linking:"+error);

        gl.deleteProgram(gl.program);
        gl.deleteProgram(fragmentShader);
        gl.deleteProgram(vertexShader);

        return null;
    }

    gl.useProgram(gl.program);
	}
	
	function start() {
		var glot = new grapher();
		glot.initialize();
		gen_shaders(glot.getContext());
		var f = function() { glot.reshape(); glot.display() };
		setInterval(f, 10);
	}
	</script>
	
	<style type="text/css">
	canvas {
		border: 1px solid black;
		width:90%;
		height:90%;
	}
	</style>
</head>
<body onload="start()">
	<canvas id="glot">
		There is supposed to be an example drawing here, but it's not important.
	</canvas>
	<div id="framerate"></div>
</body>
</html>
